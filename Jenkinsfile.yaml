pipeline:
  agent:
    label: "docker"

  environment:
    DOCKER_IMAGE: "sriramhukum/mytestapp"
    TAG: "latest"

  stages:
    - stage: "Checkout"
      steps:
        - checkout: "git"

    - stage: "Build Docker Image"
      steps:
        - sh: |
            echo "Building Docker image..."
            docker build -t ${DOCKER_IMAGE}:${TAG} .

    - stage: "Login to DockerHub"
      steps:
        - withCredentials:
            - id: "dockerhub-cred"
              usernameVariable: "DOCKER_USER"
              passwordVariable: "DOCKER_PASS"
        - sh: |
            echo "${DOCKER_PASS}" | docker login -u "${DOCKER_USER}" --password-stdin

    - stage: "Push Docker Image"
      steps:
        - sh: |
            echo "Pushing Docker image..."
            docker push ${DOCKER_IMAGE}:${TAG}

  post:
    always:
      - sh: |
          echo "Cleaning up..."
          docker logout
